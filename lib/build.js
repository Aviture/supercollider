var fs         = require('fs');
var handlebars = require('./handlebars');
var path       = require('path');
var rimraf     = require('rimraf');

// Creates HTML pages out of an object of components, and writes them to disk.
// tree: an object of components generated by Super.process().
module.exports = function(tree) {
  // Fetch template code
  var fileData = fs.readFileSync(this.options.template);

  // Compile it into Handlebars templates
  var template = handlebars.compile(fileData.toString(), {noEscape: true});

  // Erase an existing build folder and recreate it
  if (fs.existsSync(this.options.dest)) {
    rimraf.sync(this.options.dest)
  }
  fs.mkdirSync(this.options.dest);

  // For each component in the list, render a template with that component's data and write it to disk
  for (var i in tree) {
    var data = tree[i];

    // Compile the page
    var pageHTML = template(data);

    // Write to disk
    var outputPath = path.join(process.cwd(), this.options.dest, data.fileName+'.html');
    fs.writeFileSync(outputPath, pageHTML);
  }
}